# 房源 RAG 知识库项目计划

这是一个从零开始构建一个基于房源信息的检索增强生成（RAG）知识库的详细计划。

## 第一阶段：环境与数据库设置

**目标：** 使用 Docker 准备好所有开发工具和基础数据存储。

1.  **[已完成] 技术栈确认:**
    *   后端框架: `FastAPI`
    *   RAG 核心: `LangChain`
    *   AI 模型: `Google Gemini`
    *   数据库: `PostgreSQL + pgvector`
    *   部署方式: `Docker`

2.  **[待办] 创建项目结构与 Docker 配置:**
    *   创建 `ingest.py` (数据处理脚本)。
    *   创建 `app.py` (API 服务)。
    *   创建 `requirements.txt` (项目依赖)。
    *   创建 `.env.example` (环境变量模板)。
    *   创建 `Dockerfile` (用于构建应用镜像)。
    *   创建 `docker-compose.yml` (用于编排所有服务)。

3.  **[待办] 启动 Docker 环境:**
    *   安装 Docker 和 Docker Compose。
    *   根据 `.env.example` 创建 `.env` 文件，并填入 Google API Key 和数据库连接信息。
    *   在项目根目录运行 `docker-compose up -d --build` 来启动数据库和应用服务。

4.  **[待办] 初始化数据库:**
    *   使用数据库管理工具（如 DBeaver, TablePlus）或 `docker exec` 连接到 Docker 运行的 PostgreSQL 容器。
    *   在数据库中启用 `pgvector` 扩展 (`CREATE EXTENSION IF NOT EXISTS vector;`)。
    *   创建 `properties` 表（如果尚未自动创建）。
    *   向表中插入示例数据。

## 第二阶段：数据处理与入库 (Ingestion)

**目标：** 将数据库中的房源文本信息转换成向量并存储，完成知识库的构建。

1.  **[待办] 编写 `ingest.py` 脚本:**
    *   **连接数据库**: 从 `.env` 文件加载配置，连接到 PostgreSQL。
    *   **加载数据**: 使用 `pandas.read_sql_query` 读取 `properties` 表中 `description_embedding` 为空的房源。
    *   **文本处理**: 将每条房源信息（如 `title` + `description`）整合成用于向量化的文本。
    *   **向量化**: 初始化 `GoogleGenerativeAIEmbeddings`，对整合后的文本进行批量向量化。
    *   **数据回写**: 将生成的向量更新回 `properties` 表对应的 `description_embedding` 列。
    *   **测试脚本**: 插入几条示例数据到数据库，运行脚本，验证向量是否成功生成和存储。

## 第三阶段：构建 RAG 查询应用

**目标：** 创建一个 API 服务，可以接收用户问题，并通过 RAG 流程生成答案。

1.  **[待办] 搭建 `app.py` 基础服务:**
    *   使用 `FastAPI` 创建一个基本的 Web 服务器。
    *   定义一个 API 入口点 (endpoint)，例如 `/ask`，用于接收用户的 POST 请求（包含问题）。

2.  **[待办] 实现 RAG 核心逻辑:**
    *   **初始化**: 在 `app.py` 中，加载环境变量，初始化 `ChatGoogleGenerativeAI` 模型和 `GoogleGenerativeAIEmbeddings` 模型。
    *   **设置 Vector Store**: 配置 LangChain 的 `PGVector` 组件，使其连接到我们的数据库和 `properties` 表。这将作为我们的“检索器”(Retriever)。
    *   **创建 RAG Chain**: 使用 LangChain 表达式语言 (LCEL) 将以下步骤链接起来：
        1.  接收用户问题。
        2.  从 `PGVector` 检索器中查找最相关的房源文档。
        3.  构建一个包含上下文（检索到的房源信息）和用户问题的提示 (Prompt)。
        4.  将提示发送给 `ChatGoogleGenerativeAI` 模型。
        5.  获取模型生成的最终答案。
    *   **返回结果**: 将模型生成的答案作为 API 响应返回给用户。

3.  **[待办] 测试 API 服务:**
    *   运行 `uvicorn app:app --reload` 启动服务。
    *   使用 `curl` 或 FastAPI 自动生成的交互式文档 (`/docs`) 来测试 `/ask` 接口，提出关于房源的问题，检验返回结果的准确性。

## 第四阶段：优化与部署 (可选)

**目标：** 提升应用健壮性并准备生产部署。

1.  **[待办] 增加混合搜索 (Meta-filtering):**
    *   修改 RAG 链，使其能够处理更复杂的查询，例如“在上海，价格低于500万的家庭公寓”，实现结构化过滤与语义搜索的结合。
2.  **[待办] 容器化:**
    *   创建 `Dockerfile`，将 FastAPI 应用打包成一个 Docker 镜像。
    *   使用 `docker-compose.yml` 来统一管理应用容器和 PostgreSQL 数据库容器。
3.  **[待办] 创建简单前端 (可选):**
    *   使用 `Streamlit` 或 `Gradio` 快速创建一个简单的Web界面，用户可以直接在页面上提问，而不是通过API。

---
我们将按照这个计划，一步步完成整个项目。
