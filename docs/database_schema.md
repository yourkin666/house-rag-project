# 房源 RAG 知识库 - 数据表结构详细说明

本文档详细解释了房源 RAG 项目中所使用的 PostgreSQL 数据库中的三个核心数据表：`properties`、`langchain_pg_collection` 和 `langchain_pg_embedding`。

## 表结构概览

- **`properties`**: 这是我们自己设计的**核心业务表**，用来存放房源的具体信息。
- **`langchain_pg_collection`** & **`langchain_pg_embedding`**: 这是 `LangChain` 框架为了管理和搜索向量数据，在数据库中**自动创建的系统表**。我们通常不直接操作它们，而是通过 LangChain 的接口来使用。

---

### 1. `properties` 表 (房源信息表)

这张表是整个应用的核心，所有原始的房源数据都保存在这里。

**表作用**: 存储、管理和查询所有房源的详细、结构化信息。

| 字段名 (Column) | 数据类型 (Type) | 是否为空 (Nullable) | 详细说明 | 示例 (Example) |
| :--- | :--- | :--- | :--- | :--- |
| `id` | `SERIAL PRIMARY KEY`| 不允许 | **房源的唯一ID**。`SERIAL` 表示这是一个自动增长的整数，每次插入新数据时，数据库会自动为其分配一个唯一的、递增的数字。`PRIMARY KEY` 表示它是主键，用于唯一标识每一条记录。 | `1`, `2`, `101` |
| `title` | `TEXT` | 不允许 | **房源标题**。`TEXT` 类型可以存储任意长度的字符串，用于存放房源的名称或广告标题。 | `'浦东新区豪华家庭别墅'` |
| `location` | `TEXT` | 允许 | **房源所在位置**。用于描述房源的地理位置，比如城市、区县、街道等。 | `'上海市浦东新区'` |
| `price` | `NUMERIC(15, 2)` | 允许 | **房源价格**。`NUMERIC(15, 2)` 是一种精确的数字类型，总共最多15位数，其中小数点后可以有2位。这非常适合存储金额，可以避免计算误差。在这个项目中，单位是**万元**。 | `1500.00` (代表1500万元) |
| `description` | `TEXT` | 允许 | **房源的详细描述**。用于存放关于房源的大段介绍性文字，比如房间布局、装修情况、周边设施等。 | `'这是一套位于浦东新区核心地段的豪华别墅...'` |
| `description_embedding` | `VECTOR(768)` | 允许 | **描述的向量**。这是RAG的核心。`VECTOR(768)` 是 `pgvector` 扩展提供的特殊类型，用于存储一个包含768个浮点数的数组。这个向量是由AI模型（如Gemini）根据`description`等文本信息生成的，它代表了文本的“语义含义”。数据库可以通过计算向量之间的距离来找到含义最相似的房源。 | `[-0.012, 0.345, ..., 0.098]` (一个包含768个数字的数组) |
| `created_at` | `TIMESTAMP` | 允许 (有默认值) | **记录创建时间**。`TIMESTAMP` 用于存储日期和时间。该字段设置了默认值为 `CURRENT_TIMESTAMP`，意味着当你插入一条新房源时，数据库会自动将当前时间填入这个字段。 | `'2023-10-27 10:00:00'` |
| `updated_at` | `TIMESTAMP` | 允许 (有默认值) | **记录最后更新时间**。同样是 `TIMESTAMP` 类型。通过一个**触发器 (Trigger)**，每当这条房源记录被修改时，数据库会自动将当前时间更新到这个字段，方便追踪数据的最后修改时间。 | `'2023-10-28 15:30:00'` |

---

### 2. `langchain_pg_collection` 表 (向量集合管理表)

这张表由 LangChain 自动创建，作用类似于一个“文件夹”，用来管理不同的向量数据集。

**表作用**: 记录和区分不同的向量集合（Collection）。

| 字段名 (Column) | 数据类型 (Type) | 是否为空 (Nullable) | 详细说明 | 示例 (Example) |
| :--- | :--- | :--- | :--- | :--- |
| `uuid` | `UUID` | 不允许 | **集合的唯一ID**。`UUID` 是一种全局唯一的标识符，确保即使在不同的数据库中也不会重复。这是这张表的主键。 | `'f81d4fae-7dec-11d0-a765-00a0c91e6bf6'` |
| `name` | `VARCHAR` | 允许 | **集合的名称**。一个方便人类阅读和理解的名称，用来标识这个向量集合的用途。在我们的应用里，默认可能就叫 `langchain`。 | `'langchain'` |
| `cmetadata` | `JSON` | 允许 | **集合的元数据**。`JSON` 类型可以存储复杂的、结构化的信息。这里可以存放关于这个集合的额外配置或描述信息，但通常情况下可能为空。 | `{'description': '房源描述向量集合'}` |

---

### 3. `langchain_pg_embedding` 表 (向量和文档存储表)

这张表也是由 LangChain 自动创建的，是进行向量搜索时**真正查询的表**。它存放了从 `properties` 表同步过来的文本内容、生成的向量以及相关的元数据。

**表作用**: 存储文本、向量和元数据，并提供高效的相似性搜索能力。

| 字段名 (Column) | 数据类型 (Type) | 是否为空 (Nullable) | 详细说明 | 示例 (Example) |
| :--- | :--- | :--- | :--- | :--- |
| `uuid` | `UUID` | 不允许 | **嵌入记录的唯一ID**。这张表的主键，唯一标识每一条嵌入（embedding）记录。 | `'c3b3e3e0-9b1b-4e6a-8f0e-3e3e3e3e3e3e'` |
| `collection_id` | `UUID` | 允许 | **集合ID (外键)**。这个字段的值对应 `langchain_pg_collection` 表中的 `uuid`。通过它，可以知道这条向量记录属于哪个“文件夹”（集合），把不同的向量数据隔离开。 | `'f81d4fae-7dec-11d0-a765-00a0c91e6bf6'` |
| `embedding` | `VECTOR(768)` | 允许 | **向量数据**。和 `properties` 表中的 `description_embedding` 作用一样，存放的是文本内容的语义向量。LangChain 在进行相似性搜索时，主要就是在这个字段上进行计算和匹配。 | `[0.023, -0.117, ..., -0.456]` |
| `document` | `VARCHAR` | 允许 | **原始文本内容**。这是生成向量的原始文本。当 LangChain 找到最相似的向量后，会把这个 `document` 字段的内容作为“上下文”返回给AI模型，用于生成最终答案。**从代码分析，这里存的是拼接后的完整房源信息**。 | `'房源：豪华家庭别墅。位于 上海市浦东新区...'` |
| `cmetadata` | `JSON` | 允许 | **文档的元数据**。非常重要的字段！用于存放与这条 `document` 相关的**结构化信息**。从 `app.py` 代码中可以看到，这里存放了房源的 `id`, `title`, `location`, `price` 等信息。这样，在检索到相似文档后，就能立刻知道这是哪一套房源，并将这些信息一并返回给用户。 | `{"property_id": 1, "title": "豪华家庭别墅", ...}` |
| `custom_id` | `VARCHAR` | 允许 | **自定义ID**。LangChain 提供的一个字段，可以用来存储来自外部系统的ID，方便数据关联和同步。在这个项目中目前似乎没有使用。 | `NULL` or `'property_1_v2'` |
